# mysql数据恢复脚本

- 不能保证所有表数据都可以恢复，测试结果为大部分数据表可以恢复，但是部分表字段中含有大量数据时可能会报错，目前还没找到原因。
- 记得备份数据库
- 记得备份数据库
- 记得备份数据库

## 恢复表结构

- 前提 `*.frm` 文件必须存在

1. 配置基础配置信息
2. 在mysql中执行 `show tables;` ，获取基础表名称，将获取到的表名称复制在 `$tables` 变量中
3. 执行 `generateTempCreateTablesSql()` 获取基础表 `sql` ，然后在新建数据库执行 `sql`
4. 将原有数据库中的 `*.frm` 文件覆盖在新数据库下
5. 执行 `getOriginalCreateTablesSql()` 获取原有表创建 `sql`

## 恢复表数据

- 恢复原理是在使用独立表空间的情况下,如果在innodb使用独立表空间的情况下,ibdata文件会记录每个innodb表的id,只要使得ibd中的表id和ibdata文件中记录的表id相同,就能够打开表,读取到数据
- 创建新的数据库，按待恢复表的结构创建好数据库
- 使用 `vim` 打开 `*.ibd` 文件，执行 `:%!xxd` 转换为十六进制查看
- 加粗加下划线的地方为表 `id`
- 把 `new.ibd` 中的 `id` 替换至待 `old.ibd` 中
- `:%!xxd -r` 保存数据 `:wq` 退出 `vim`
- 把修改后的文件复制在新数据库中覆盖 `*.ibd`
- 修改 `my.conf` 中 `innodb_force_recovery = 6`
- 重启数据库
- 
- 待恢复表的数据 `old.ibd`<br>
  0000000: 5be9 e0b7 0000 0000 0000 0000 0000 0000  [...............<br>
  0000010: 0000 0013 607f 5758 0008 0000 0000 0000 ....`.WX........<br>
  <u>**0000020: 0005 0000 0000 2100 0000 0000 0000 00c2  ......!.........**</u><br>
  0000030: 03c0 0000 0280 0000 0000 0000 0026 0000 .............&..<br>
  0000040: 0002 0000 0000 01de 0000 0000 0206 0000 ................<br>
  0000050: 0001 0000 0000 00ee 0000 0000 00ee 0000 ................<br>

- 新表数据 `new.ibd`<br>
  0000000: 3277 242f 0000 0000 0000 0000 0000 0000 2w$/............<br>
  0000010: 0000 0013 5fbc 2391 0008 0000 0000 0000 ...._.#.........<br>
  <u>**0000020: 0000 0000 00c0 0000 00c0 0000 0000 0000 ................**</u><br>
  0000030: 1600 0000 1480 0000 0000 0000 002e 0000 ................<br>
  0000040: 0002 0000 0000 0d1e 0000 0000 0d46 0000 .............F..<br>

- 最终表数据<br>
  0000000: 5be9 e0b7 0000 0000 0000 0000 0000 0000  [...............<br>
  0000010: 0000 0013 607f 5758 0008 0000 0000 0000 ....`.WX........<br>
  <u>**0000020: 0000 0000 00c0 0000 00c0 0000 0000 0000 ................**</u><br>
  0000030: 03c0 0000 0280 0000 0000 0000 0026 0000 .............&..<br>
  0000040: 0002 0000 0000 01de 0000 0000 0206 0000 ................<br>
  0000050: 0001 0000 0000 00ee 0000 0000 00ee 0000 ................<br>

- 以下为脚本
1. 配置基础配置信息
2. 执行 `modifyIbdHeaderId()` 方法
3. 新文件会输出至 `$newFilesDir` 目录中


---
- 目前可能脚本还有缺陷，欢迎补充 `pr`